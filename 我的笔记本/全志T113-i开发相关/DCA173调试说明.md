# DCA173调试说明

## 2025-12-19：

### 1、显示调试：

经过仔细研究代码发现，全志T113-i这款芯片u-boot代码下做了很多工作：

- 启动时u-boot会自动将内核的dtb设备加载到内存；

- 如果u-boot打开了`BOOT_GUI`宏开关，则还会根据u-boot下的dtb设备树的显示设置去更改内核的dtb中关于显示的设置；

- 如果u-boot同时还打开了以下配置：

```sh
Sunxi cmd  --->
	[*] sunxi display param update
```

则u-boot启动时还会查找分区：`boot-resource`下是否存在显示设置文件：`disp_config.ini`，如果存在，则根据INI配置文件中的设备来设置显示输出。

`disp_config.ini`的内容参考如下：

```ini
; Example disp_config.ini for sunxi display parameter update
; Place this file on the FAT partition named 'bootloader' or 'boot-resource'
; as 'disp_config.ini' so U-Boot can load and apply it when
; CONFIG_AIOT_DISP_PARAM_UPDATE and CONFIG_FAT_WRITE are enabled.
;
; This example targets a single LVDS panel @ 800x480 and uses
; the `default_lcd` panel driver.

[disp0]
dev_num=1
chn_cfg_mode=0
lcd_index=0
output_mode=1
output_type=1
do_hpd=0
screen_id=0
fb_width=800
fb_height=480

[primary_display]
display_type=lvds
device_num=1
de_id=0
framebuffer_width=800
framebuffer_height=480
dpix=160
dpiy=160

[lcd0]
panel_driver_name=default_lcd
status=okay
used=1
dclk_freq=33264000
ht=1056
x=800
hspw=48
hbp=200
vt=525
y=480
vbp=20
vspw=10
tcon_mode=0
tcon_en_odd_even_div=0
start_delay=0
backlight=255
backlight_delay=0
pwm_used=1
pwm_ch=0
pwm_freq=1000
pwm_pol=0
pwm_max_limit=255
if=3
lvds_if=0
lvds_colordepth=0
lvds_mode=1
lcd_port=lvds0

[hdmi]
status=disabled

[edp]
status=disabled

[dp]
compatible=sunxi,dp
status=disabled
ssc_en=0
lane_cnt=4

```

将INI配置文件：`disp_config.ini`复制到`boot-resource`目录下，重新编译并pack系统，最后生成的文件：`boot-resource.fex`中就包含了系统启动加载的资源。

> [!note]
>
> 注意`boot-reource`分区为**fat16**分区，分区编号：**/dev/mmcblk0p1**。

---

## 2025-12-14：

### 1、内核与dtb分离的方法：

按照《SWA113i开发调试相关.md》文档中的描述，只需要2步：

1.1. 第一步，内核仍旧按照boot.img来进行烧写，也不需要修改u-boot环境变量，只需要将dsp0那个分区的名称改为：dtb

```sh
sgdisk -c=6:"dtb" /dev/mmcblk0
```

1.2. 第二步，将编译好的dtb文件直接烧写到这个分区即可：

```sh
dd if=dca173_v1.0.dtbo of=/dev/mmcblk0p6
```

重启系统，就会加载新的设备树了。

---

### 2、以太网配置：

#### 2.1. 内核配置如下：

```sh
Device Drivers  --->
	[*] Network device support  --->
		[*]   Ethernet driver support  --->
			[*]   Allwinner devices
			< >     Allwinner A10 EMAC support
			< >     Allwinner GMAC support
			<*>   Allwinner GMAC NG support
			-*-   Allwinner GMAC MDIO NG support
			[ ]   Allwinner GMAC NG metadata support
```

#### 2.2. dtb设备树配置如下：

- `sun8iw20p1.dtsi`下的配置：

```c
mdio0: mdio0@4500048 {
	status = "okay";
	compatible = "allwinner,sunxi-mdio";
	#address-cells = <1>;
	#size-cells = <0>;
	reg = <0x0 0x04500048 0x0 0x8>;
	gmac0_phy0: ethernet-phy@1 {
		//reg = <1>;
		reg = <0>;
        
        //"ethernet-phy-id001c.c816": 根据of_mdio.c中的要求，此处填写rtl8201f PHY的ID。
        //* Return true if the child node is for a phy. It must either:
 		//* o Compatible string of "ethernet-phy-idX.X"
 		//* o Compatible string of "ethernet-phy-ieee802.3-c45"
 		//* o Compatible string of "ethernet-phy-ieee802.3-c22"
		compatible = "ethernet-phy-id001c.c816", "ethernet-phy-ieee802.3-c22";
		max-speed = <100>;  /* Max speed capability */
		reset-gpios = <&pio PE 13 GPIO_ACTIVE_LOW>;
		/* PHY datasheet rst time */
		reset-assert-us = <10000>;
		reset-deassert-us = <15000>;
	};
};

gmac0: gmac0@4500000 {
	compatible = "allwinner,sunxi-gmac";
	reg = <0x0 0x04500000 0x0 0x10000>,
	      <0x0 0x03000030 0x0 0x4>;
	interrupts = <GIC_SPI 46 IRQ_TYPE_LEVEL_HIGH>;
	interrupt-names = "gmacirq";
	clocks = <&ccu CLK_BUS_EMAC0>, <&ccu CLK_EMAC0_25M>;
	clock-names = "gmac", "phy25m";
	resets = <&ccu RST_BUS_EMAC0>;
	phy-handle = <&gmac0_phy0>;
	status = "disabled";
};
```

- `board.dts`板级设备中的配置（dca173_v1.0.dts）：

```c
&gmac0 {
	pinctrl-0 = <&gmac0_pins_a>;
	pinctrl-1 = <&gmac0_pins_b>;
	pinctrl-names = "default", "sleep";
	phy-mode = "rmii";
	use_ephy25m = <1>;
	//use_ephy25m = <0>;
	sunxi,phy-clk-type = <0>;
	tx-delay = <7>;
	rx-delay = <31>;
	phy-rst = <&pio PE 13 GPIO_ACTIVE_HIGH>;
	status = "okay";
};
```

> [!note]
>
> 注意原来官方的配置中没有：
>
> ```c
> sunxi,phy-clk-type = <0>;
> ```
>
> 这一句配置，但是文档：
>
> [/mnt/hgfs/H_DRIVE/全志T113i和T536官方资料_20250103/T113i资料/20240624_t113i/Software软件类文档/SDK模块开发指南/Linux_EMAC_开发指南.pdf](/mnt/hgfs/H_DRIVE/全志T113i和T536官方资料_20250103/T113i资料/20240624_t113i/Software软件类文档/SDK模块开发指南/Linux_EMAC_开发指南.pdf)
>
> 在第“3.2.3.2.1 gmac 配置说明“节中有关于这句话的描述。
>
> 再对照源代码：
>
> [/media/jason/btrfs_disk_M/Develop/allwinner/T113X_V1.1/kernel/linux-5.4/drivers/net/ethernet/allwinner/sunxi-gmac-ng/sunxi-gmac.c](/media/jason/btrfs_disk_M/Develop/allwinner/T113X_V1.1/kernel/linux-5.4/drivers/net/ethernet/allwinner/sunxi-gmac-ng/sunxi-gmac.c)
>
> ```c
> static int sunxi_gmac_resource_get(struct platform_device *pdev)
> {
>     ...
>     ret = of_property_read_u32(np, "sunxi,phy-clk-type", &chip->phy_clk_type);
>     if (ret) {
>         dev_err(&pdev->dev, "Error: Get gmac phy-clk-type failed\n");
>         return -EINVAL;
>     }
> }
> ```
>
> 说明dtb中必须要配置这个属性，否则网卡驱动加载失败。

**按照这样的设置后，百兆网卡加载成功。实测网速在11.3MiB/秒左右。**

### 3、CAN通讯配置：

#### 3.1. 根据全志杨廷瑞提供的参考配置：

![image-20251215114029976](/home/jason/BaiduSyncdisk/VNote笔记本_20200401/我的笔记本/全志T113-i开发相关/images/image-20251215114029976.png)

#### 3.2. 设备树文件配置如下：

```c
/{
    awlink0: awlink@0x0 {
        pinctrl-names = "default", "sleep";
        pinctrl-0 = <&can0_pins_a>;
        pinctrl-1 = <&can0_pins_b>;
        #address-cells = <1>;
        #size-cells = <0>;
        compatible = "allwinner,sun8i-awlink";
        device_type = "awlink0";
        id = <0>;
        status = "okay";
    };
    awlink1: awlink@0x1 {
        pinctrl-names = "default", "sleep";
        pinctrl-0 = <&can1_pins_a>;
        pinctrl-1 = <&can1_pins_b>;
        #address-cells = <1>;
        #size-cells = <0>;
        compatible = "allwinner,sun8i-awlink";
        device_type = "awlink1";
        id = <1>;
        status = "okay";
    };
};

&pio {
	vcc-pc-supply = <&reg_pio3_3>;
	input-debounce = <0 0 0 0 0 1>;

	can0_pins_a: can0_pins@0 {  /* For EVB1 board */
		pins = "PB2", "PB3";
		function = "can0";
		drive-strength = <10>;
		bias-pull-up;
	};
	can0_pins_b: can0_pins@1 {  /* For EVB1 board */
		pins = "PB2", "PB3";
		function = "gpio_in";
	};

	can1_pins_a: can1_pins@0 {  /* For EVB1 board */
		pins = "PB4", "PB5";
		function = "can1";
		drive-strength = <10>;
		bias-pull-up;
	};

	can1_pins_b: can1_pins@1 {  /* For EVB1 board */
		pins = "PB4", "PB5";
		function = "gpio_in";
	};
};
```

#### 3.3. 内核源码修改如下：

修改文件：[/media/jason/btrfs_disk_M/Develop/allwinner/T113X_V1.1/kernel/linux-5.4/drivers/pinctrl/sunxi/pinctrl-sun8iw20.c](/media/jason/btrfs_disk_M/Develop/allwinner/T113X_V1.1/kernel/linux-5.4/drivers/pinctrl/sunxi/pinctrl-sun8iw20.c)

```c
	SUNXI_PIN(SUNXI_PINCTRL_PIN(B, 2),
		SUNXI_FUNCTION(0x0, "gpio_in"),
		SUNXI_FUNCTION(0x1, "gpio_out"),
		SUNXI_FUNCTION(0x2, "lcd0"),		/* D0 */
		SUNXI_FUNCTION(0x3, "i2s2_dout"),	/* DOUT2 */
		SUNXI_FUNCTION(0x4, "twi0"),		/* SDA */
		SUNXI_FUNCTION(0x5, "i2s2_din"),	/* DIN2 */
		SUNXI_FUNCTION(0x6, "lcd0"),		/* D18 */
		SUNXI_FUNCTION(0x7, "uart4"),		/* TX */
//RAY.Wang: 2025-12-15，添加can0引脚
		SUNXI_FUNCTION(0x8, "can0"),		/* AWLINK0 */

		SUNXI_FUNCTION_IRQ_BANK(0xE, 0, 2),
		SUNXI_FUNCTION(0xF, "io_disabled")),
	SUNXI_PIN(SUNXI_PINCTRL_PIN(B, 3),
		SUNXI_FUNCTION(0x0, "gpio_in"),
		SUNXI_FUNCTION(0x1, "gpio_out"),
		SUNXI_FUNCTION(0x2, "lcd0"),		/* D1 */
		SUNXI_FUNCTION(0x3, "i2s2_dout"),	/* DOUT1 */
		SUNXI_FUNCTION(0x4, "twi0"),		/* SCK */
		SUNXI_FUNCTION(0x5, "i2s2_din"),	/* DIN0 */
		SUNXI_FUNCTION(0x6, "lcd0"),		/* D19 */
		SUNXI_FUNCTION(0x7, "uart4"),		/* RX */
		SUNXI_FUNCTION(0x8, "can0"),		/* AWLINK0 */
		SUNXI_FUNCTION_IRQ_BANK(0xE, 0, 3),
		SUNXI_FUNCTION(0xF, "io_disabled")),
	SUNXI_PIN(SUNXI_PINCTRL_PIN(B, 4),
		SUNXI_FUNCTION(0x0, "gpio_in"),
		SUNXI_FUNCTION(0x1, "gpio_out"),
		SUNXI_FUNCTION(0x2, "lcd0"),		/* D8 */
		SUNXI_FUNCTION(0x3, "i2s2_dout"),	/* DOUT0 */
		SUNXI_FUNCTION(0x4, "twi1"),		/* SCK */
		SUNXI_FUNCTION(0x5, "i2s2_din"),	/* DIN1 */
		SUNXI_FUNCTION(0x6, "lcd0"),		/* D20 */
		SUNXI_FUNCTION(0x7, "uart5"),		/* TX */
		SUNXI_FUNCTION(0x8, "can1"),		/* AWLINK1 */
		SUNXI_FUNCTION_IRQ_BANK(0xE, 0, 4),
		SUNXI_FUNCTION(0xF, "io_disabled")),
	SUNXI_PIN(SUNXI_PINCTRL_PIN(B, 5),
		SUNXI_FUNCTION(0x0, "gpio_in"),
		SUNXI_FUNCTION(0x1, "gpio_out"),
		SUNXI_FUNCTION(0x2, "lcd0"),		/* D9 */
		SUNXI_FUNCTION(0x3, "i2s2"),		/* BCLK */
		SUNXI_FUNCTION(0x4, "twi1"),		/* SDA */
		SUNXI_FUNCTION(0x5, "pwm0"),
		SUNXI_FUNCTION(0x6, "lcd0"),		/* D21 */
		SUNXI_FUNCTION(0x7, "uart5"),		/* RX */
		SUNXI_FUNCTION(0x8, "can1"),		/* AWLINK1 */
		SUNXI_FUNCTION_IRQ_BANK(0xE, 0, 5),
		SUNXI_FUNCTION(0xF, "io_disabled")),
```

#### 3.2. 设置：

```sh
ip link set awlink0 type can bitrate 125000 restart-ms 100
ip link set awlink0 up
```

如果设置成功，则可以通过以下命令来查看状态：

```sh
SWA-113I:~# ip -d link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 
2: awlink0: <NOARP,UP,LOWER_UP,ECHO> mtu 16 qdisc pfifo_fast state UP mode DEFAULT group default qlen 10
    link/can  promiscuity 0 
    can state ERROR-WARNING (berr-counter tx 117 rx 0) restart-ms 100 
          bitrate 125000 sample-point 0.875 
          tq 500 prop-seg 6 phase-seg1 7 phase-seg2 2 sjw 1
          sunxi-awlink: tseg1 1..16 tseg2 2..8 sjw 1..4 brp 2..1024 brp-inc 1
          clock 24000000numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 
3: awlink1: <NOARP,UP,LOWER_UP,ECHO> mtu 16 qdisc pfifo_fast state UP mode DEFAULT group default qlen 10
    link/can  promiscuity 0 
    can state ERROR-ACTIVE (berr-counter tx 0 rx 0) restart-ms 100 
          bitrate 125000 sample-point 0.875 
          tq 500 prop-seg 6 phase-seg1 7 phase-seg2 2 sjw 1
          sunxi-awlink: tseg1 1..16 tseg2 2..8 sjw 1..4 brp 2..1024 brp-inc 1
          clock 24000000numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 
```

#### 3.3. 通讯收发测试：

```sh
cansend_cycle awlink0 111#11223344556677889900
canrecv awlink0
```

---



