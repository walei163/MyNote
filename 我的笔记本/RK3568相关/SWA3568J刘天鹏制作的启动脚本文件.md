# SWA3568J刘天鹏制作的启动脚本文件

如下所示，是刘天鹏制作的关于我司SWA3568J核心板的启动脚本，后续新出厂的设备将按照这个脚本中的设计来实现文件分区和文件系统格式：
1. 分区：

```bash
mmcblk0p6: 作为挂载/usr/local的分区，用户分区
mmcblk0p7: 将原来的oem分区由128MB扩大为10GB，作为btrfs快照备份分区。挂载到/snapshot。
mmcblk0p8: 挂载rootfs分区
```
2. 文件系统：

```bash
mmcblk0p6: btrfs
mmcblk0p7: btrfs
mmcblk0p8: ext4
```

| Flash分区名称 | 文件系统格式 | 挂载分区名称 |   分区大小   |                      备注                       |
| :-----------: | :---------: | :---------: | :----------: | :--------------------------------------------: |
|   mmcblk0p6   |    btrfs    | /usr/local  |     3GB      |         存放用户可读写的程序代码，数据等          |
|   mmcblk0p7   |    btrfs    |  /snapshot  |     10GB     | 用于给/usr/local等可读写的btrfs分区数据打快照备份 |
|   mmcblk0p8   |    ext4     |      /      | eMMC剩下全部 |       用于系统的根文件系统，包括ubuntu等。        |
|               |             |             |              |                                                |
|               |             |             |              |                                                |
|               |             |             |              |                                                |
|               |             |             |              |                                                |
|               |             |             |              |                                                |
|               |             |             |              |                                                |
|               |             |             |              |                                                |

3. 脚本源码：

```bash
#!/bin/bash

#set hostname
/bin/hostname -F /etc/hostname

#set vt100
export TERM=vt100
export TERMINFO=/usr/share/terminfo

#set system time from RTC
#hwclock -s

#RK3568
PARTNAME=`sgdisk --info=6 /dev/mmcblk0 | grep name | cut -d  "'" -f2`
if [ $PARTNAME == "rootfs" ] ; then
        #old partition p6:rootfs:3G(ext4)  p7:oem:128M(ext2) p8:userdata:-(ext4)
	fsck.ext4 -y -f /dev/mmcblk0p8
	mount -t ext4 /dev/mmcblk0p8 /usr/local
        
	#FS_TYPE=`blkid /dev/mmcblk0p8 cut -s "TYPE" | cut -d '=' -f2 | cut -d '"' -f2`
        #if [ ${FS_TYPE} != "btrfs" ] ; then
	#	echo "Fmort /dev/mmcblk0p8 $FS_TYPE to btrfs..."
	#       mkfs.btrfs -f -L "userdata" /dev/mmcblk0p8 
        #fi
        #mount -t btrfs /dev/mmcblk0p8 /usr/local
        #btrfs scrub start /dev/mmcblk0p8
else
        #new partition p6:userdata:3G(btrfs)  p7:oem:10G(btrfs) p8:rootfs:-(ext4)
        FS_TYPE=`blkid /dev/mmcblk0p6 cut -s "TYPE" | cut -d '=' -f2 | cut -d '"' -f2`
        if [ ${FS_TYPE} != "btrfs" ] ; then
		echo "Fmort /dev/mmcblk0p6 $FS_TYPE to btrfs..."
                mkfs.btrfs -f -L "userdata" /dev/mmcblk0p6 
        fi
        mount -t btrfs /dev/mmcblk0p6 /usr/local
        btrfs scrub start /dev/mmcblk0p6

        FS_TYPE=`blkid /dev/mmcblk0p7 cut -s "TYPE" | cut -d '=' -f2 | cut -d '"' -f2`
        if [ ${FS_TYPE} != "btrfs" ] ; then
		echo "Fmort /dev/mmcblk0p7 $FS_TYPE to btrfs..."
                mkfs.btrfs -f -L "oem" /dev/mmcblk0p7
        fi
        mount -t btrfs /dev/mmcblk0p7 /snapshot
        btrfs scrub start /dev/mmcblk0p7
fi

mkdir -p /usr/local/tcu/nandflash
mkdir -p /usr/local/tcu/opt
mkdir -p /usr/local/data
mkdir -p /usr/local/bin
mkdir -p /usr/local/lib
mkdir -p /usr/local/lib/cgi-bin
mkdir -p /usr/local/lib/www
mkdir -p /usr/local/etc
mkdir -p /usr/local/libs
mkdir -p /usr/local/apps
mkdir -p /usr/local/app_data
mkdir -p /usr/local/root
mkdir -p /usr/local/LiXiang/lib

ln -fs /usr/local/apps /apps
ln -fs /usr/local/app_data /app_data

if [ ! -e /usr/local/LiXiang/lib/rsyslog ]; then
	cp /usr/lib/rsyslog /usr/local/LiXiang/lib/ -raf
fi

#set network
#/sbin/ifconfig eth0 hw ether 00:E0:0C:30:95:11
#/sbin/ifconfig eth1 hw ether 00:E0:0C:30:95:12

#/sbin/ifconfig eth0 192.168.1.230
#/sbin/ifconfig eth1 192.168.2.230

/sbin/ifconfig lo 127.0.0.1

echo "Starting vsftpd..."
vsftpd &

echo "Starting sshd..."
/usr/sbin/sshd -f /etc/ssh/sshd_config &

#mount -o remount,ro /
#start user script
#/work/data/rc.user start

```