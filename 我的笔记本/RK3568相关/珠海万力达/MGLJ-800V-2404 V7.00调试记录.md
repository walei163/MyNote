# MGLJ-800V-2404 V7.00调试记录

## 1. CPU自带的2路网口的问题：

现象：

```bash
第1路插入网线后硬件自协商非常缓慢，并且自协商的结果，网速最高只能到100Mbps。
第2路网口不通。
```

解决方案：

1）第2路网口默认内核DTB中没有配置，将其配置以后，第2路网口可以正确加载了。但是现象会和第1路网口一样，自协商非常缓慢，自协商完成后，最高速度只能到100Mbps。

2）检查硬件原理图发现，系统设计了3路千兆以太网，但是4组差分线在连接RJ45插座时均设计错误。如下图所示：

![image-20240508165624284](C:\Users\walei163\AppData\Roaming\Typora\typora-user-images\image-20240508165624284.png)

其中的`“MDI1_P”`和`“MDI1_N”`设计错误，应该遵循下面的线序接线：

![image-20240508170301236](C:\Users\walei163\AppData\Roaming\Typora\typora-user-images\image-20240508170301236.png)

也就是：

| 信号管脚 | RJ45对应管脚 |
| :------: | :----------: |
|  MDI0_P  |    RJ45_1    |
|  MDI0_N  |    RJ45_2    |
|  MDI1_P  |    RJ45_3    |
|  MDI1_N  |    RJ45_6    |
|  MDI2_P  |    RJ45_4    |
|  MDI2_N  |    RJ45_5    |
|  MDI3_P  |    RJ45_7    |
|  MDI3_N  |    RJ45_8    |

> [!note]
>
> <font face="微软雅黑" color=cyan>**这个问题需要硬件改板才能解决。**</font>



## 2. CPU自带的串口问题：

现象：

```bash
2、3路串口内核没有驱动。
1、4串口使用时内核会报错，但功能正常
```

解决方案：

1）需要配置DTB，配置完成后，2、3路串口就可以使用了。

硬件设计串口和Linux串口设备号的对应：

| 硬件设计串口 | Linux设备号 |
| :----------: | :---------: |
|  TXD0/RXD0   | /dev/ttyS0  |
|  TXD1/RXD1   | /dev/ttyS7  |
|  TXD2/RXD2   | /dev/ttyS3  |
|  TXD3/RXD3   | /dev/ttyS4  |

2）内核报错信息如下：

```bash
root@MGLJ-800V-V7:~# ll > /dev/ttyS0
[  695.195883] of_dma_request_slave_channel: dma-names property of node '/serial@fdd50000' missing or empty
[  695.195925] ttyS0 - failed to request DMA, use interrupt mode
```

这个其实不是错误信息，是内核提示信息，表示当前串口没有使用`DMA方式`收发数据，而是采用的`中断模式`收发数据。

一般第一次打开串口时会出现该提示，用户不需要关注。



## 3. RTC：PCF8563找不到的问题：

现象：

```bash
PCF8563 RTC设备初始化出错，不能对其进行写操作，初始化失败，无法生成/dev/rtc1设备节点
```

解决方案：

1）拆下核心板观察发现，核心板背面RTC芯片旁边的晶振`Y1`已经掉落，并且上面的焊盘也有被带起的情况，怀疑是在插拔核心板的过程中，因为用力或者角度不当的问题，导致将晶振`Y1`带掉。重新补焊一个晶振，重启系统，RTC设备找到，问题解决。

## 4.NPU操作调试方法
### 1）上电后先查看NPU版本
```bash
root@MGLJ-800V-V7:~# cat /sys/kernel/debug/rknpu/driver_version
RKNPU driver: v0.7.2
```
如果板卡显示如上所示，则说明NPU驱动已经正确加载。

### 2）查询NPU电源状态
```bash
root@MGLJ-800V-V7:~# cat /sys/kernel/debug/rknpu/power
off
```
上电默认状态下，NPU电源状态处于`off`模式，需要手动打开电源。

### 3）打开NPU电源
```bash
root@MGLJ-800V-V7:~# echo on > /sys/kernel/debug/rknpu/power
root@MGLJ-800V-V7:~# [ 1565.690705] RKNPU: rknpu power is on!
```
如果操作正确，则等待一会，会出现上述提示：`“[ 1565.690705] RKNPU: rknpu power is on!”`
如果要关闭NPU电源，操作如下：

```bash
echo off > /sys/kernel/debug/rknpu/power
```
### 4）设定NPU运行频率

查看一下NPU当前的频率：
```bash
root@MGLJ-800V-V7:~# cat /sys/class/devfreq/fde40000.npu/cur_freq
600000000
```
默认状态下，NPU频率为`600MHz`。

查看一下NPU可以提供的频率：
```bash
root@MGLJ-800V-V7:~# cat /sys/class/devfreq/fde40000.npu/available_frequencies 
200000000 297000000 400000000 600000000 700000000 800000000 900000000
```
上述说明，NPU的频率范围：`200 ~ 900MHz`。
调节NPU频率，例如将NPU频率调整到最大：`900MHz`：
```bash
root@MGLJ-800V-V7:~# echo userspace > /sys/class/devfreq/fde40000.npu/governor
root@MGLJ-800V-V7:~# echo 900000000 > /sys/class/devfreq/fde40000.npu/userspace/set_freq
root@MGLJ-800V-V7:~# cat /sys/class/devfreq/fde40000.npu/cur_freq
900000000
```
按照以上步骤，可以看到，我们已经将NPU的运行频率手动调整到了`900MHz`，也就是最大值。
按照上述操作后，可以正常使用NPU资源了。

## 5. 查看和设置开发板的 CPU、 DDR 和 NPU 频率

### 1）CPU频率查看与设置

```bash
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq

或 cat

/sys/kernel/debug/clk/clk_summary | grep arm
```

设定CPU频率

```bash
# 查看 CPU 可用频率

cat /sys/devices/system/cpu/cpufreq/policy0/scaling_available_frequencies

408000 600000 816000 1008000 1200000 1416000 1608000 1704000

# 设置 CPU 频率， 例如， 设置 1.7GHz

echo userspace > /sys/devices/system/cpu/cpufreq/policy0/scaling_governor

echo 1704000 > /sys/devices/system/cpu/cpufreq/policy0/scaling_setspeed
```



### 2）DDR频率查看与设置

```bash
cat /sys/class/devfreq/dmc/cur_freq

或 cat

/sys/kernel/debug/clk/clk_summary | grep ddr
```

设定DDR频率（需要固件支持）

```bash
# 查看 DDR 可用频率

cat /sys/class/devfreq/dmc/available_frequencies

# 设置 DDR 频率， 例如， 设置 1560MHz

echo userspace > /sys/class/devfreq/dmc/governor

echo 1560000000 > /sys/class/devfreq/dmc/userspace/set_freq
```

