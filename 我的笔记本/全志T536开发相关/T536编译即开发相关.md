# T536编译即开发相关

## 1、系统代码目录：

[/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/](/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/)

## 2、编译：

### 2.1. 关于目录介绍参照这个文档：

[《Tina_Linux_系统软件_开发指南.pdf》](/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/Tina_Linux_系统软件_开发指南.pdf)

进入到系统目录下，运行：

```sh
$ source build/envsetup.sh 
NOTE: The SDK(/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1) was successfully loaded
load buildroot,bsp...ok
Invoke . build/quick.sh from your shell to add the following functions to your environment:
    croot / cl                     - Changes directory to the top of the tree
    cbrandy                        - Changes directory to the brandy
    cspl / cboot0                  - Changes directory to the spl
    csbi[10|14] / copensbi[10|14]  - Changes directory to the opensbi
    cu / cuboot / cboot            - Changes directory to the uboot
    cubsp / cubootbsp / cbootbsp   - Changes directory to the uboot-bsp
    carisc                         - Changes directory to the arisc
    ck / ckernel                   - Changes directory to the kernel
    cbsp                           - Changes directory to the bsp
    cbsptest                       - Changes directory to the bsptest
    cdts                           - Changes directory to the kernel's dts
    cchip / cchips                 - Changes directory to the chip
    cbin                           - Changes directory to the chip's bin
    cboard / cconfigs / cbd        - Changes directory to the board
    crootfs                        - Changes directory to the rootfs
    cdsp                           - Changes directory to the dsp
    crtos                          - Changes directory to the rtos
    crtoshal / crtos-hal           - Changes directory to the rtos-hal
    cbuild                         - Changes directory to the build
    cbr                            - Changes directory to the buildroot
    copenssl                       - Changes directory to the product's openssl-1.0.0
    cout                           - Changes directory to the product's output
    ckout / ckernelout             - Changes directory to the kernel output
    ctarget                        - Changes directory to the target
    chostbin                       - Changes directory to the hostbin
    cplat                          - Changes directory to the platform
    ccommon                        - Changes directory to the common
Usage: build.sh [args]
    build.sh                       - default build all
    build.sh bootloader            - only build bootloader
    build.sh kernel                - only build kernel
    build.sh buildroot_rootfs      - only build buildroot
    build.sh uboot_menuconfig       - edit uboot menuconfig
    build.sh uboot_saveconfig       - save uboot menuconfig
    build.sh menuconfig            - edit kernel menuconfig
    build.sh saveconfig            - save kernel menuconfig
    build.sh recovery_menuconfig   - edit recovery menuconfig
    build.sh recovery_saveconfig   - save recovery menuconfig
    build.sh buildroot_menuconfig  - edit buildroot menuconfig
    build.sh buildroot_saveconfig  - save buildroot menuconfig
    build.sh clean                 - clean all
    build.sh distclean             - distclean all
    build.sh pack                  - pack firmware
    build.sh pack_debug            - pack firmware with debug info output to card0
    build.sh pack_secure           - pack firmware with secureboot
Usage: pack [args]
    pack                           - pack firmware
    pack -d                        - pack firmware with debug info output to card0
    pack -s                        - pack firmware with secureboot
    pack -sd                       - pack firmware with secureboot and debug info output to card0
```



### 2.2. 配置build.sh：

```sh
./build.sh config
```

此时出现以下内容：

```sh
$ ./build.sh config
04-27 14:30:11.659   23193 D mkcommon  : ========ACTION List: mk_config ;========
04-27 14:30:11.660   23193 D mkcommon  : options : 
All available platform:
   0. android
   1. linux
Choice [linux]: 
All available linux_dev:
   0. bsp
   1. ubuntu
   2. buildroot
Choice [buildroot]: 
All available ic:
   0. t536
Choice [t536]: 
All available board:
   0. demo
   1. demo_amp
   2. demo_kylo
   3. demo_nand
   4. demo_nor
   5. demo_raw_nand
Choice [demo]: 
All available flash:
   0. default
   1. nor
Choice [default]: 
All available kern_name:
   0. linux-5.10-euler
   1. linux-5.10-origin
   2. linux-5.10-rt
   3. linux-5.10-xenomai
   4. linux-5.15-origin
Choice [linux-5.10-origin]: 
04-27 14:30:41.976   24772 D bsp       : Setup BSP files
04-27 14:30:42.010   23193 I mkcommon  : Prepare toolchain ...
04-27 14:30:42.051   23193 I mkcommon  : kernel defconfig: generate /media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/out/t536/kernel/build/.config by /media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/device/config/chips/t536/configs/demo/linux-5.10-origin/buildroot_linux_defconfig
04-27 14:30:42.053   23193 I mkcommon  : Prepare toolchain ...
04-27 14:30:42.088   23193 D mkcommon  : make: Entering directory '/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/kernel/linux-5.10-origin'
04-27 14:30:42.091   23193 D mkcommon  : make[1]: 进入目录“/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/out/t536/kernel/build”
04-27 14:30:42.195   23193 D mkcommon  : GEN     Makefile
04-27 14:30:42.224   23193 D mkcommon  : *** Default configuration is based on '../../../../../device/config/chips/t536/configs/demo/linux-5.10-origin/buildroot_linux_defconfig'
04-27 14:30:43.261   23193 D mkcommon  : #
04-27 14:30:43.262   23193 D mkcommon  : # No change to .config
04-27 14:30:43.263   23193 D mkcommon  : #
04-27 14:30:43.264   23193 D mkcommon  : make[1]: 离开目录“/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/out/t536/kernel/build”
04-27 14:30:43.266   23193 D mkcommon  : make: Leaving directory '/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/kernel/linux-5.10-origin'
make: Entering directory '/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/buildroot/buildroot-202205'
  GEN     /media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/out/t536/demo/buildroot/buildroot/Makefile
Config.in.legacy:232:warning: choice value used outside its choice group
#
# configuration written to /media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/out/t536/demo/buildroot/buildroot/.config
#
make: Leaving directory '/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/buildroot/buildroot-202205'
04-27 14:30:43.702   23193 I mkcommon  : buildroot defconfig is sun55iw6p1_t536_defconfig 
04-27 14:30:48.681   23193 I mkcommon  : clean buildserver
04-27 14:30:48.684   23193 I mkcommon  : prepare_buildserver
```

### 2.3. 编译配置内核：

1）配置内核：

```sh
./build.sh menuconfig
```

配置完成后，需要保存配置：

```sh
./build.sh saveconfig
```

2）编译内核：

```sh
./build.sh kernel
```

### 2.4. sys_config.fex文件说明：

1）文件位于：[/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/device/config/chips/t536/configs/demo/](/media/jason/btrfs_disk_M/Develop/allwinner/t536/V1.1/device/config/chips/t536/configs/demo/)

1. sys_config 的主要作用：打包阶段根据 sys_config 配置更新 boot0, uboot, optee 等 bin 文件的头部等信息，例如更新dram 参数、 uart 参数等。 

2. 根据 1 描述，在修改 sys_config 之后，重新打包即可, 无需重新 make 编译

2）文件内容：

```sh
;sunxi platform application
;---------------------------------------------------------------------------------------------------------
; 说明： 脚本中的字符串区分大小写，用户可以修改"="后面的数值，但是不要修改前面的字符串
; 描述gpio的形式：Port:端口+组内序号<功能分配><内部电阻状态><驱动能力><输出电平状态>
;---------------------------------------------------------------------------------------------------------
[platform]
debug_mode  = 1

;----------------------------------------------------------------------------------
;[target]  system bootup configuration
;power_mode | xxxx | x | xxx | (8 bit)
;            vol_val ve axp_id
;vol_val: 0 : use default sys_vol
;      1~15 : 900mV + (vol_val - 1) * 20mV
;ve     : 0 : 1080p
;         1 : 4k
;axp_id : 0 : no axp, dummy
;         1 : use axp2202 dcdc1 - sys
;         2 : use axp2202 dcdc2 - sys
;             (with axp2202 dcdc1 - cpu)
;----------------------------------------------------------------------------------
[target]
power_mode      = 2

[card0_boot_para]
card_ctrl       = 0
card_high_speed = 1
card_line       = 4
sdc_d1          = port:PF0<2><1><2><default>
sdc_d0          = port:PF1<2><1><2><default>
sdc_clk         = port:PF2<2><1><3><default>
sdc_cmd         = port:PF3<2><1><2><default>
sdc_d3          = port:PF4<2><1><2><default>
sdc_d2          = port:PF5<2><1><2><default>
;sdc_type	= "tm1"

[card2_boot_para]
card_ctrl       = 2
card_high_speed = 1
card_line       = 8
sdc_clk         = port:PC5<3><1><3><default>
sdc_cmd         = port:PC6<3><1><1><default>
sdc_d0          = port:PC10<3><1><1><default>
sdc_d1          = port:PC13<3><1><1><default>
sdc_d2          = port:PC15<3><1><1><default>
sdc_d3          = port:PC8<3><1><1><default>
sdc_d4          = port:PC9<3><1><1><default>
sdc_d5          = port:PC11<3><1><1><default>
sdc_d6          = port:PC14<3><1><1><default>
sdc_d7          = port:PC16<3><1><1><default>
sdc_emmc_rst    = port:PC1<3><1><3><default>
sdc_ds          = port:PC0<3><2><3><default>

[uart_para]
uart_debug_port = 0
uart_debug_tx   = port:PB09<2><1><default><default>
uart_debug_rx   = port:PB10<2><1><default><default>

[jtag_para]
jtag_enable     = 1
jtag_ms         = port:PB0<4><default><default><default>
jtag_ck         = port:PB1<4><default><default><default>
jtag_do         = port:PB2<4><default><default><default>
jtag_di         = port:PB3<4><default><default><default>

[twi_para]
twi_used        = 1
twi_port        = 6
twi_scl         = port:PL0<2><1><default><default>
twi_sda         = port:PL1<2><1><default><default>

;*****************************************************************************
;
;dram select configuration
;
;select_mode	:	dram模式选择,	0:不进行自动识别
;					1:gpio识别模式(dram_para, dram_para1-15, 共16组有效)
;					2:gpadc识别模式(dram_para, dram_para1-7, 共8组有效)
;					3:2个IO+gpadc识别模式(dram_para, dram_para1-32, 共33组有效)。其中IO配置优先级按select_gpio0>select_gpio1>select_gpio2>select_gpio3
;gpadc_channel	:	选择gpadc通道	有效值(0-3)
;select_gpio1-4	:	选择gpio pin
;*****************************************************************************

[dram_select_para]
select_mode	= 0
gpadc_channel	= 1
select_gpio0	= port:PH16<0><1><default><default>
select_gpio1	= port:PH17<0><1><default><default>
;select_gpio2	= port:PH1<0><1><default><default>
;select_gpio3	= port:PH0<0><1><default><default>


;*****************************************************************************
;sdram configuration
;
;*****************************************************************************
[dram_para]
dram_clk       = 720
dram_type      = 8
dram_dx_odt    = 0x07070707
dram_dx_dri    = 0x0d0d0d0d
dram_ca_dri    = 0x0e0e
dram_para0     = 0x84848484
dram_para1     = 0x30fa
dram_para2     = 0x00000000
dram_mr0       = 0x0
dram_mr1       = 0x34
dram_mr2       = 0x00
dram_mr3       = 0x33
dram_mr4       = 0x3
dram_mr5       = 0x0
dram_mr6       = 0x0
dram_mr11      = 0x04
dram_mr12      = 0x72
dram_mr13      = 0x0
dram_mr14      = 0x0000000e
dram_mr16      = 0x0
dram_mr17      = 0x0
dram_mr22      = 0x26
dram_tpr0      = 0x80808080
dram_tpr1      = 0x0a0a0a0a
dram_tpr2      = 0x0
dram_tpr3      = 0x0
dram_tpr6      = 0x38000000
dram_tpr10     = 0x862e0000
dram_tpr11     = 0xc0c3c0c3
dram_tpr12     = 0x2e312d2e
dram_tpr13     = 0x00000C60
dram_tpr14     = 0x48484848

[dram_para1]
dram_clk       = 720
dram_type      = 8
dram_dx_odt    = 0x07070707
dram_dx_dri    = 0x0d0d0d0d
dram_ca_dri    = 0x0e0e
dram_para0     = 0x84848484
dram_para1     = 0x30fa
dram_para2     = 0x00000000
dram_mr0       = 0x0
dram_mr1       = 0x34
dram_mr2       = 0x00
dram_mr3       = 0x33
dram_mr4       = 0x3
dram_mr5       = 0x0
dram_mr6       = 0x0
dram_mr11      = 0x04
dram_mr12      = 0x72
dram_mr13      = 0x0
dram_mr14      = 0x00000007
dram_mr16      = 0x0
dram_mr17      = 0x0
dram_mr22      = 0x26
dram_tpr0      = 0x80808080
dram_tpr1      = 0x06060606
dram_tpr2      = 0x0
dram_tpr3      = 0x0
dram_tpr6      = 0x40000000
dram_tpr10     = 0x802e0000
dram_tpr11     = 0x9a9a9a9a
dram_tpr12     = 0x0e0f070a
dram_tpr13     = 0x00000061
dram_tpr14     = 0x48484848
```

