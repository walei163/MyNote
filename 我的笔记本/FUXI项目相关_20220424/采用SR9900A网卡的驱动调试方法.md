# 采用SR9900A网卡的驱动调试方法

在思创`FUXI_DTU V2.0`的板卡上，设计修改了2路USB以太网卡，采用的是**深圳市和芯润德科技有限公司的SR9900AI芯片**，官方提供的驱动中说明，可以采用CDC模式的通用USB驱动，但是实际使用中发现有以下几个问题：

1、拔插网卡时，系统没有任何提示，也就是没有提示carirrer on和off；

2、小刘和廖工实际测试时发现，在进行ftp传输时，如果传输数据贷款一旦过大，系统就会崩溃。

**因此，可能不能使用这个通用的CDC驱动，选择采用官方提供的自有驱动。**

**但是官方提供的Linux驱动：sr9900-linux-3.10.x-release-driver经过编译测试，不能支持FUXI内核版本4.19，并且去除错误后，插入模块会出现内核崩溃信息，也就是，这个驱动不能支持FUXI内核。**

不过，研究该驱动代码发现，SR9900的驱动几乎是完全在`rtl8152.c`的驱动代码上修改的，因此，猜测也许可以直接修改4.19内核的`rtl8152`的驱动代码，使其能够满足SR9900的驱动要求。

实际改动了rtl8152.c的代码如下：

```c
/* Define these values to match your device */
#define VENDOR_ID_REALTEK		0x0bda
#define VENDOR_ID_MICROSOFT		0x045e
#define VENDOR_ID_SAMSUNG		0x04e8
#define VENDOR_ID_LENOVO		0x17ef
#define VENDOR_ID_LINKSYS		0x13b1
#define VENDOR_ID_NVIDIA		0x0955
#define VENDOR_ID_TPLINK		0x2357
#define	VENDOR_ID_CORECHIP		0x0fe6

#define	PRODUCT_ID_SR9900		0x9900
...

/* table of devices that work with this driver */
static const struct usb_device_id rtl8152_table[] = {
	{REALTEK_USB_DEVICE(VENDOR_ID_REALTEK, 0x8050)},
	{REALTEK_USB_DEVICE(VENDOR_ID_REALTEK, 0x8152)},
	{REALTEK_USB_DEVICE(VENDOR_ID_REALTEK, 0x8153)},
	{REALTEK_USB_DEVICE(VENDOR_ID_MICROSOFT, 0x07ab)},
	{REALTEK_USB_DEVICE(VENDOR_ID_MICROSOFT, 0x07c6)},
	{REALTEK_USB_DEVICE(VENDOR_ID_SAMSUNG, 0xa101)},
	{REALTEK_USB_DEVICE(VENDOR_ID_LENOVO,  0x304f)},
	{REALTEK_USB_DEVICE(VENDOR_ID_LENOVO,  0x3062)},
	{REALTEK_USB_DEVICE(VENDOR_ID_LENOVO,  0x3069)},
	{REALTEK_USB_DEVICE(VENDOR_ID_LENOVO,  0x7205)},
	{REALTEK_USB_DEVICE(VENDOR_ID_LENOVO,  0x720c)},
	{REALTEK_USB_DEVICE(VENDOR_ID_LENOVO,  0x7214)},
	{REALTEK_USB_DEVICE(VENDOR_ID_LINKSYS, 0x0041)},
	{REALTEK_USB_DEVICE(VENDOR_ID_NVIDIA,  0x09ff)},
	{REALTEK_USB_DEVICE(VENDOR_ID_TPLINK,  0x0601)},
	{REALTEK_USB_DEVICE(VENDOR_ID_CORECHIP,  PRODUCT_ID_SR9900)},
	{}
};

MODULE_DEVICE_TABLE(usb, rtl8152_table);
```

也就是增加了SR9900的VID和PID到`usb_device_id`的表中即可，而这2个ID信息可以直接在板卡上得到：

```sh
root@CSG-FUXI:~# lsusb
Bus 001 Device 001: ID 1d6b:0002
Bus 001 Device 002: ID 0fe6:9900
```

**这样改完后，重新编译内核，并烧录到板子上，重启系统，结果SR9900网卡真的可以使用了。**

然后可以采用iperf3来测试网络的带宽：

在板卡上运行服务器端：

```sh
root@CSG-FUXI:~# iperf3 -s
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
Accepted connection from 192.168.1.177, port 36032
[  5] local 192.168.1.223 port 5201 connected to 192.168.1.177 port 36036
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  10.6 MBytes  89.3 Mbits/sec                  
[  5]   1.00-2.00   sec  11.2 MBytes  94.0 Mbits/sec                  
[  5]   2.00-3.00   sec  11.2 MBytes  94.1 Mbits/sec                  
[  5]   3.00-4.00   sec  11.2 MBytes  94.0 Mbits/sec                  
[  5]   4.00-5.00   sec  11.2 MBytes  94.1 Mbits/sec                  
[  5]   5.00-6.00   sec  11.2 MBytes  94.1 Mbits/sec                  
[  5]   6.00-7.00   sec  11.2 MBytes  94.1 Mbits/sec                  
[  5]   7.00-8.00   sec  11.2 MBytes  94.1 Mbits/sec                  
[  5]   8.00-9.00   sec  11.2 MBytes  94.1 Mbits/sec                  
[  5]   9.00-10.00  sec  11.2 MBytes  94.1 Mbits/sec                  
[  5]  10.00-10.13  sec  1.49 MBytes  93.8 Mbits/sec                  
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-10.13  sec   113 MBytes  93.6 Mbits/sec                  receiver
-----------------------------------------------------------
Server listening on 5201
-----------------------------------------------------------
```

然后在电脑侧运行客户端：

```sh
$ iperf3 -c 192.168.1.223
Connecting to host 192.168.1.223, port 5201
[  5] local 192.168.1.177 port 36036 connected to 192.168.1.223 port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.01   sec  14.6 MBytes   121 Mbits/sec    1    570 KBytes       
[  5]   1.01-2.01   sec  11.3 MBytes  95.0 Mbits/sec    0    585 KBytes       
[  5]   2.01-3.00   sec  10.5 MBytes  88.4 Mbits/sec    0    600 KBytes       
[  5]   3.00-4.00   sec  11.7 MBytes  98.8 Mbits/sec    0    614 KBytes       
[  5]   4.00-5.00   sec  10.8 MBytes  90.0 Mbits/sec    0    628 KBytes       
[  5]   5.00-6.00   sec  10.9 MBytes  91.2 Mbits/sec    0    642 KBytes       
[  5]   6.00-7.00   sec  12.4 MBytes   104 Mbits/sec    0    691 KBytes       
[  5]   7.00-8.00   sec  11.2 MBytes  94.4 Mbits/sec    0    762 KBytes       
[  5]   8.00-9.00   sec  11.2 MBytes  94.4 Mbits/sec    0    857 KBytes       
[  5]   9.00-10.00  sec  11.2 MBytes  94.4 Mbits/sec    0    970 KBytes       
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec   116 MBytes  97.2 Mbits/sec    1             sender
[  5]   0.00-10.13  sec   113 MBytes  93.6 Mbits/sec                  receiver
```

显示带宽满足100MBps的要求。如果想要多次测试，可以执行iperf3客户端命令如下（-i时间间隔，-t测试次数）：

```sh
iperf3 -c 192.168.1.223 -i 1 -t 30
```

表示每次发送间隔1秒，测试30次。

> [!note]
>
> 1、修改该内核，需要在配置内核中去掉：
>
> ```sh
> CDC Ethernet support (smart devices such as cable modems)
> ```
>
> 这个配置选项。
>
> 2、在文件系统中，需要删掉`lib/modules/4.19.15/kernel/drivers/net`下与USB相关的选项模块，否则系统启动时会出现崩溃信息。

## 2、SR9900网卡MAC地址说明：

采用`rtl8152`驱动后，根据官方的文档说明，SR9900AI的出厂芯片中已经内置了MAC地址，因此，可以发现MAC地址是固定的。如下所示：

```sh
root@CSG-FUXI:~# ifconfig eth1
eth1      Link encap:Ethernet  HWaddr 00:E0:9A:01:03:4D  
          inet addr:192.168.1.223  Bcast:192.168.1.255  Mask:255.255.255.0
          inet6 addr: fe80::2e0:9aff:fe01:34d/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:12532 errors:0 dropped:430 overruns:0 frame:0
          TX packets:3468 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:9858678 (9.4 MiB)  TX bytes:1314834 (1.2 MiB)
```

也就是MAC地址都是：00:E0:9A:xx:xx:xx这样，因此，我们可以不用考虑对SR9900AI的网卡重新设置MAC地址。

## 3、VLAN设置：

使用中发现，采用rtl8152驱动后，可以直接对SR9900AI的网卡进行`ethtool`和`vlan id`的设置，例如：

```sh
vconfig add eth1 10
```

这样系统中就出现了一个vlan编号为10的网络设置接口：

```sh
root@CSG-FUXI:~# ifconfig -a
eth1      Link encap:Ethernet  HWaddr 00:E0:9A:01:03:4D  
          inet addr:192.168.1.223  Bcast:192.168.1.255  Mask:255.255.255.0
          inet6 addr: fe80::2e0:9aff:fe01:34d/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:12532 errors:0 dropped:430 overruns:0 frame:0
          TX packets:3468 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:9858678 (9.4 MiB)  TX bytes:1314834 (1.2 MiB)

eth1.10   Link encap:Ethernet  HWaddr 00:E0:9A:01:03:4D  
          inet addr:192.168.2.223  Bcast:192.168.2.255  Mask:255.255.255.0
          inet6 addr: fe80::2e0:9aff:fe01:34d/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:529 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1283 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:71941 (70.2 KiB)  TX bytes:1158284 (1.1 MiB)
```

对eth1.10设置好IP地址后，就可以使用了。

## 4、出现USB状态错误的处理：

但是设置vlan之后，我的电脑上设置同一段的vlan，和板卡连接公司交换机后，进行ping通讯时，会出现USB传输错误：

```sh
root@CSG-FUXI:~# [ 1540.044868] r8152 2-1:1.0 eth1: Stop submitting intr, status -104
[ 1540.205980] usb 2-1: USB disconnect, device number 2
[ 1540.514783] usb 2-1: new high-speed USB device number 3 using dwc2
[ 1540.868788] usb 2-1: reset high-speed USB device number 3 using dwc2
```

有时可以恢复，有时不能恢复，必须重新上电系统才可以重新初始化。

通过研究`rtl8152.c`的代码，发现该处理在以下代码处：

```c
static void read_bulk_callback(struct urb *urb)
```

那么可以将status=-104这种问题在代码中进行一个简单处理：

```c
switch (status) {
case 0:
	if (urb->actual_length < ETH_ZLEN)
		break;
	spin_lock_irqsave(&tp->rx_lock, flags);
	list_add_tail(&agg->list, &tp->rx_done);
	spin_unlock_irqrestore(&tp->rx_lock, flags);
	napi_schedule(&tp->napi);
	return;
case -ESHUTDOWN:
	set_bit(RTL8152_UNPLUG, &tp->flags);
	netif_device_detach(tp->netdev);
	return;
case -ENOENT:
	return;	/* the urb is in unlink state */
//RAY.Wang: 2025-01-01, add for ECONNRESET
//屏蔽-104错误
case -ECONNRESET:
	return;
case -ETIME:
	if (net_ratelimit())
		netdev_warn(netdev, "maybe reset is needed?\n");
	break;
default:
	if (net_ratelimit())
		netdev_warn(netdev, "Rx status %d\n", status);
	break;
}
```

**对于-104状态的错误情况，直接返回即可。这样系统就不会出现错误信息了。**

## 5、有时候系统启动时，2路网卡的eth编号会出现混乱：

2025-01-07：

经过研究，可以采用以下方案来完美解决网卡编号混乱的问题：

### 1）在内核驱动中设定SR9900A网卡的名称，因此需要修改驱动代码：`sr9900_sanway.c`：

```c
static int rtl8152_probe(struct usb_interface *intf,
			 const struct usb_device_id *id)
{
    ...
    netdev = alloc_etherdev(sizeof(struct r8152));
    if (!netdev) {
        dev_err(&intf->dev, "Out of memory\n");
        return -ENOMEM;
    }
    //RAY.Wang 2019-12-10，设置网卡名称
    //注意：次数修改是为了满足配合udev命名的要求
    strncpy(netdev->name, "usb_lan%d", IFNAMSIZ);
    SET_NETDEV_DEV(netdev, &intf->dev);
}
```

> **也就是将SR9900A的网卡名称设置为：“usb_lan%d”这样的名称。**

### 2）在`/etc/udev/rules.d/`下增加udev配置文件：`usb-ethernet.rules`

```sh
KERNEL=="usb_lan*",SUBSYSTEM=="net",KERNELS=="1-1:1.0",NAME="eth1"
KERNEL=="usb_lan*",SUBSYSTEM=="net",KERNELS=="2-1:1.0",NAME="eth2"
```

---

此时可以用udevadm来查询以下网卡的具体信息：

```sh
root@CSG-FUXI:~# udevadm info -a -p /sys/class/net/eth1

Udevadm info starts with the device specified by the devpath and then
walks up the chain of parent devices. It prints for every device
found, all possible attributes in the udev rules key format.
A rule to match, can be composed by the attributes of the device
and the attributes from one single parent device.

  looking at device '/devices/platform/soc/a0006000.usb/usb1/1-1/1-1:1.0/net/eth1':
    KERNEL=="eth1"
    SUBSYSTEM=="net"
    DRIVER==""
    ATTR{carrier_up_count}=="1"
    ATTR{duplex}=="full"
    ATTR{addr_assign_type}=="0"
    ATTR{address}=="00:e0:9a:01:03:4d"
    ATTR{link_mode}=="0"
    ATTR{dev_id}=="0x0"
    ATTR{carrier_down_count}=="1"
    ATTR{iflink}=="6"
    ATTR{operstate}=="up"
    ATTR{netdev_group}=="0"
    ATTR{type}=="1"
    ATTR{tx_queue_len}=="1000"
    ATTR{speed}=="100"
    ATTR{ifalias}==""
    ATTR{gro_flush_timeout}=="0"
    ATTR{mtu}=="1500"
    ATTR{ifindex}=="6"
    ATTR{broadcast}=="ff:ff:ff:ff:ff:ff"
    ATTR{dormant}=="0"
    ATTR{dev_port}=="0"
    ATTR{addr_len}=="6"
    ATTR{flags}=="0x1003"
    ATTR{carrier}=="1"
    ATTR{carrier_changes}=="2"
    ATTR{proto_down}=="0"

  looking at parent device '/devices/platform/soc/a0006000.usb/usb1/1-1/1-1:1.0':
    KERNELS=="1-1:1.0"
    SUBSYSTEMS=="usb"
    DRIVERS=="r8152"
    ATTRS{bInterfaceProtocol}=="00"
    ATTRS{supports_autosuspend}=="1"
    ATTRS{bInterfaceClass}=="ff"
    ATTRS{authorized}=="1"
    ATTRS{bInterfaceNumber}=="00"
    ATTRS{bInterfaceSubClass}=="ff"
    ATTRS{bAlternateSetting}==" 0"
    ATTRS{bNumEndpoints}=="03"

  looking at parent device '/devices/platform/soc/a0006000.usb/usb1/1-1':
    KERNELS=="1-1"
    SUBSYSTEMS=="usb"
    DRIVERS=="usb"
    ATTRS{bmAttributes}=="a0"
    ATTRS{configuration}==""
    ATTRS{bNumConfigurations}=="2"
    ATTRS{idVendor}=="0fe6"
    ATTRS{version}==" 2.10"
    ATTRS{bMaxPower}=="100mA"
    ATTRS{speed}=="480"
    ATTRS{busnum}=="1"
    ATTRS{devspec}=="  (null)"
    ATTRS{product}=="USB 10/100 LAN"
    ATTRS{rx_lanes}=="1"
    ATTRS{bcdDevice}=="2000"
    ATTRS{urbnum}=="145644"
    ATTRS{ltm_capable}=="no"
    ATTRS{maxchild}=="0"
    ATTRS{devnum}=="2"
    ATTRS{bDeviceProtocol}=="00"
    ATTRS{bNumInterfaces}==" 1"
    ATTRS{tx_lanes}=="1"
    ATTRS{bConfigurationValue}=="1"
    ATTRS{avoid_reset_quirk}=="0"
    ATTRS{manufacturer}=="CoreChips"
    ATTRS{bDeviceClass}=="00"
    ATTRS{serial}=="00E09A01034D"
    ATTRS{authorized}=="1"
    ATTRS{devpath}=="1"
    ATTRS{removable}=="unknown"
    ATTRS{quirks}=="0x0"
    ATTRS{idProduct}=="9900"
    ATTRS{bMaxPacketSize0}=="64"
    ATTRS{bDeviceSubClass}=="00"

  looking at parent device '/devices/platform/soc/a0006000.usb/usb1':
    KERNELS=="usb1"
    SUBSYSTEMS=="usb"
    DRIVERS=="usb"
    ATTRS{urbnum}=="35"
    ATTRS{bcdDevice}=="0419"
    ATTRS{configuration}==""
    ATTRS{interface_authorized_default}=="1"
    ATTRS{bmAttributes}=="e0"
    ATTRS{bMaxPacketSize0}=="64"
    ATTRS{maxchild}=="1"
    ATTRS{devnum}=="1"
    ATTRS{authorized_default}=="1"
    ATTRS{serial}=="a0006000.usb"
    ATTRS{quirks}=="0x0"
    ATTRS{rx_lanes}=="1"
    ATTRS{bConfigurationValue}=="1"
    ATTRS{bMaxPower}=="0mA"
    ATTRS{version}==" 2.00"
    ATTRS{speed}=="480"
    ATTRS{devpath}=="0"
    ATTRS{idProduct}=="0002"
    ATTRS{bDeviceClass}=="09"
    ATTRS{authorized}=="1"
    ATTRS{idVendor}=="1d6b"
    ATTRS{tx_lanes}=="1"
    ATTRS{avoid_reset_quirk}=="0"
    ATTRS{ltm_capable}=="no"
    ATTRS{product}=="DWC OTG Controller"
    ATTRS{busnum}=="1"
    ATTRS{bNumInterfaces}==" 1"
    ATTRS{manufacturer}=="Linux 4.19.15 dwc2_hsotg"
    ATTRS{bDeviceSubClass}=="00"
    ATTRS{bNumConfigurations}=="1"
    ATTRS{removable}=="unknown"
    ATTRS{bDeviceProtocol}=="01"

  looking at parent device '/devices/platform/soc/a0006000.usb':
    KERNELS=="a0006000.usb"
    SUBSYSTEMS=="platform"
    DRIVERS=="dwc2"
    ATTRS{driver_override}=="(null)"

  looking at parent device '/devices/platform/soc':
    KERNELS=="soc"
    SUBSYSTEMS=="platform"
    DRIVERS==""
    ATTRS{driver_override}=="(null)"

  looking at parent device '/devices/platform':
    KERNELS=="platform"
    SUBSYSTEMS==""
    DRIVERS==""
```

因为SR9900AI网卡的MAC地址出厂时是固定的，因此，我们可以按照MAC地址的不同，来固定2路网卡的编号。

在`/etc/udev/rules.d/`目录下新建一个规则文件：`usb-ethernet.rules`，内容如下所示：

```sh
KERNEL=="eth*",SUBSYSTEMS=="net",ATTR{address}=="00:e0:9a:01:03:4d",NAME="eth1"
KERNEL=="eth*",SUBSYSTEMS=="net",ATTR{address}=="00:E0:9A:00:EC:D5",NAME="eth2"
```

或者按照刘天鹏的规则设计，如下所示：

```sh
root@CSG-FUXI:~# cat /etc/udev/rules.d/net.rules 
KERNEL=="eth*",SUBSYSTEM=="net",KERNELS=="1-1:1.0",NAME="eth1"
KERNEL=="eth*",SUBSYSTEM=="net",KERNELS=="2-1:1.0",NAME="eth2"
```

然后掉电再重启系统，这样eth编号就固定下来了。