# 搭建NFS服务器并从CCE-3088启动引导

文件目录：

[TOC]



## 1. 在虚拟机上搭建nfs服务器：

### 1.1. 首先，虚拟机必须要有一个独立的IP地址，因此需要将虚拟机设置为网桥连接模式。

以Virtualbox为例，其网络模式需要设置为以下模式：

![image-20240505155016469](/home/jason/.config/Typora/typora-user-images/image-20240505155016469.png)</div>

即网络的连接方式需要设置为：**“桥接网卡”**，这样虚拟机在启动之后就会带有1个独立的IP地址：

```bash
$ ifconfig
eth0: flags=-28605<UP,BROADCAST,RUNNING,MULTICAST,DYNAMIC>  mtu 1500
        inet 192.168.1.177  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::a96c:4da7:307e:efe9  prefixlen 64  scopeid 0x20<link>
        ether 08:00:27:74:41:99  txqueuelen 1000  (Ethernet)
        RX packets 402452  bytes 104785091 (99.9 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 507444  bytes 534272456 (509.5 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 902  bytes 85402 (83.4 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 902  bytes 85402 (83.4 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

以我的虚拟机为例，启动之后，网关会通过`DHCP`协议自动为我分配了一个独立IP地址：`192.168.1.177`。

### 1.2. 此时就可以安装nfs服务器了。

仍以ubuntu系统为例：

```bash
$ sudo apt install nfs-kernel-server
```

安装完成后需要设置nfs服务器：

- **第一步：修改`/etc/default/nfs-kernel-server`：**

```bash
$ sudo nano /etc/default/nfs-kernel-server
```

在文件的最后一行添加以下内容：

```bash
RPCNFSDOPTS="--nfs-version 2,3,4 --debug --syslog"
```



- **第二步：将我这边打包好的文件系统解压缩到虚拟机的目录中。**

可以解压缩到任何目录，例如解压缩到虚拟机系统的`/mnt`目录下：

```bash
$ sudo tar xzvf sanway-emmc-rootfs-4.9-stm32mp153a-swa1530_log4cxx_ACE_20230613.tar.gz -C /mnt
```

解压缩成功后，会在虚拟机的`/mnt`目录下出现以下目录：

```bash
$ ll
总用量 4.0K
drwxr-xr-x 20 root root 4.0K  6月 13 10:16 sanway-emmc-rootfs-4.9-stm32mp153a-swa1530
```

- **第三步：设置nfs服务器的`exports`文件：**

修改虚拟机上的`/etc/exports`文件：

```bash
$ sudo nano /etc/exports
```

在文件中添加以下内容：

```bash
/mnt/sanway-emmc-rootfs-4.9-stm32mp153a-swa1530/              *(rw,sync,no_root_squash,no_subtree_check)
```

表示将刚刚解压缩的目录共享出来，给客户端使用。

- **第四步，重启nfs服务，并确认服务正确加载：**

```bash
$ sudo service nfs-kernel-server restart
```

如果加载成功，则可以通过以下命令看到虚拟机上export的文件系统：

```bash
$ sudo exportfs 
/mnt/sanway-emmc-rootfs-4.9-stm32mp153a-swa1530		<world>
```

至此，虚拟机上的nfs服务器安装完毕。

### 1.3. 在`CCE-3088`装置上验证nfs服务器：

在配置`CCE-3088`装置从nfs网络文件系统加载之前，可以先验证一下。方法如下：

将装置连接好网线，要求装置和虚拟机都在同一个IP网段里。启动装置，登录系统，ping一下虚拟机的IP（设虚拟机的IP地址：`192.168.1.177`），如果可以ping通，此时键入以下命令：

```bash
root@CCE3088:~# mount -o nolock -t nfs 192.168.1.177:/mnt/sanway-emmc-rootfs-4.9-stm32mp153a-swa1530 /tmp
```

如果加载成功，则可以看到虚拟机上共享出来的文件系统：

```bash
root@CCE3088:~# ll /tmp/
drwxr-xr-x    3 1000     tisdk         1024 Dec 25  2015 Settings
drwxr-xr-x    2 1000     tisdk         2048 Jun 17  2021 bin
drwxr-xr-x    2 1000     tisdk         1024 Jan  9  2016 boot
drwxr-xr-x    2 1000     tisdk         1024 Jan 23  2016 dev
drwxr-xr-x   31 1000     tisdk         2048 May 26  2021 etc
drwxr-xr-x    4 1000     tisdk         1024 Jul  2  2019 home
lrwxrwxrwx    1 root     root            10 Aug 15  2019 init -> /sbin/init
drwxr-xr-x    8 1000     tisdk         4096 Jun 12 17:13 lib
drwx------    2 1000     tisdk         1024 Dec 25  2015 lost+found
lrwxrwxrwx    1 root     root            10 May 26  2021 media -> /run/media
drwxr-xr-x    3 1000     tisdk         1024 Sep 13  2016 mnt
drwxr-xr-x    2 root     root          1024 May 26  2021 opt
drwxr-xr-x    2 1000     tisdk         1024 Dec 25  2015 proc
lrwxrwxrwx    1 root     root            15 Jun 17  2021 root -> /usr/local/root
drwxr-xr-x    6 root     root          1024 Sep 11  2020 run
drwxr-xr-x    2 1000     tisdk         2048 Jun 13 09:54 sbin
drwxr-xr-x    3 1000     tisdk         1024 Dec 25  2015 srv
drwxr-xr-x    2 1000     tisdk         1024 Dec 25  2015 sys
lrwxrwxrwx    1 1000     tisdk            8 Dec 25  2015 tmp -> /var/tmp
drwxr-xr-x   11 1000     tisdk         1024 Dec 25  2015 usr
drwxr-xr-x    8 1000     tisdk         1024 Jun 28  2019 var
drwxr-xr-x    2 1000     tisdk         1024 Mar 29  2018 work
```

说明虚拟机上的nfs服务器已经正确的共享了。

> [!tip]
>
> <font face="微软雅黑" color=cyan>这种方法，可以直接操作虚拟机里的文件，因此从开发调试角度来说，会比采用FTP文件传输模式更加方便快捷。syslinux</font>

## 2. 在CCE-3088装置上设置从nfs服务器加载文件系统：

### 2.1. 设置`syslinux`配置文件：

修改装置上的系统文件：`/boot/mmc1_stm32mp157a-ev1_extlinux/extlinux.conf`：

```bash
root@CCE3088:~# vi /boot/mmc1_stm32mp157a-ev1_extlinux/extlinux.conf
```

添加启动选项，修改完成后的内容如下所示：

```bash
Generic Distro Configuration file generated by OpenEmbedded
#menu title Select the boot mode
MENU BACKGROUND /splash.bmp
TIMEOUT 20
DEFAULT sanway_cce3088
LABEL sanway_cce3088
        KERNEL /uImage_5.10
        FDT /sanway_cce3088-eb-a.dtb
        APPEND root=/dev/mmcblk1p4 rootwait rw console=ttySTM0,115200
LABEL dtu-2660gm-2111
        KERNEL /uImage_5.10
        FDT /wanlida_dtu-2660gm-2111_v1.02-a.dtb
        APPEND root=/dev/mmcblk1p4 rootwait rw console=ttySTM0,115200

LABEL sanway_cce3088_nfs
        KERNEL /uImage_5.10
        FDT /sanway_cce3088-eb-a.dtb
        APPEND console=ttySTM0,115200n8 root=/dev/nfs nfsroot=192.168.1.177:/mnt/sanway-emmc-rootfs-4.9-stm32mp153a-swa1530,nolock rw ip=192.168.1.223:192.168.1.177:192.168.1.1:255.255.255.0::eth0:off
```

> [!note]
>
> 带有**“LABEL”**标识的表示一个启动选项，重点是添加最后一个启动项。
>
> - 增加了**“LABEL sanway_cce3088_nfs”**这一新的启动项。
> - 在这个启动项中，**“192.168.1.177”**是你的虚拟机的IP地址，**“192.168.1.223”**是你设置的`CCE-3088`装置的IP地址。这两个IP地址都可以任意设置，只要确保在同一个网段中就行。
> - 在这个启动项中，**“eth0”**是你连接到`CCE-3088`装置上的物理网口，需要接到装置背面网络丝印的网口1（注意，此处**ethx**编号和装置上物理网口并非完全是一一对应的关系。例如：如果改为**eth1**，则网线需要连接装置背面丝印的**网口5**）。
> - 在这个启动项中，**“/mnt/sanway-emmc-rootfs-4.9-stm32mp153a-swa1530”**是你虚拟机上nfs共享出来的目录的名称，也就是要和`exportfs`输出的内容保持完全一致。

修改完成后，保存后退出vi，然后再同步一下：

```bash
root@CCE3088:~# sync
```

确保修改已经同步到了`eMMC`上。

> [!note]
>
> 注意：在`Debian12`等以上版本中，nfs的**version**默认升级到**V3**，因此需要修改启动参数如下：
>
> ```bash
> APPEND console=ttySTM0,115200n8 root=/dev/nfs nfsroot=192.168.1.177:/mnt/sanway-emmc-rootfs-4.9-stm32mp153a-swa1530,nolock,vers=3 rw ip=192.168.1.223:192.168.1.177:192.168.1.1:255.255.255.0::eth0:off
> ```
>
> 

也就是要增加：

```bash
vers=3
```

这一选项。

### 2.2. 重启装置，启动时选择`“LABEL sanway_cce3088_nfs”`这一项：

重启装置，然后选择`“LABEL sanway_cce3088_nfs”`启动项。

> [!note]
>
> <font face="微软雅黑" color=cyan>此时需要注意，装置需要连接串口调试线，并通过串口调试终端操作来完成这一选择。</font>

当重启装置时，启动界面到达如下画面时，按下回车键，系统会停止继续启动，等待用户输入选择：

<div align=left>

![image-20240505161948547](/home/jason/.config/Typora/typora-user-images/image-20240505161948547.png)</div>

<div>![image-20240505161608769](/home/jason/.config/Typora/typora-user-image

此时键入：3，回车，系统将会按照之前`“LABEL sanway_cce3088_nfs”`所做的设置来启动系统。如果启动无误，则启动画面大致如下：

![image-20240505162107209](/home/jason/.config/Typora/typora-user-images/image-20240505162107209.png)</div>

其中：

```bash
[    4.678502] IP-Config: Complete:
[    4.680353]      device=eth0, hwaddr=e2:bd:2f:ed:87:0b, ipaddr=192.168.1.223, mask=255.255.255.0, gw=192.168.1.1
[    4.690539]      host=192.168.1.223, domain=, nis-domain=(none)
[    4.696410]      bootserver=192.168.1.177, rootserver=192.168.1.177, rootpath=
```

启动到这里，出现上述的打印信息，表示内核已经可以正确的加载nfs文件系统。否则就需要查找不能加载的原因。

后续的过程和装置普通启动一样，出现登录画面，等待用户登录：

![image-20240505162213631](/home/jason/.config/Typora/typora-user-images/image-20240505162213631.png)</div>

至此，nfs文件系统加载完成。登录后和正常装置使用没有什么区别，但是此时看到的文件系统中的所有文件，实际上是虚拟机里的文件，你对文件系统所做的所有的改动和写操作，实际上操作的均为虚拟机上的文件，就是前面所述的`/mnt/sanway-emmc-rootfs-4.9-stm32mp153a-swa1530`这个目录下的文件。

> [!important]
>
> 在开发调试阶段，可以通过这种加载文件系统的开发方式，来对文件做修改，直到所有的修改工作完成，然后再将`/mnt/sanway-emmc-rootfs-4.9-stm32mp153a-swa1530`里的内容一次性打包，最后再烧写到eMMC中，这样就可以减少很多重复性的工作。

### 2.3. 通过nfs方式更新CCE-3088装置上的文件系统：

现在因为已经加载了nfs文件系统，因此可以在这种模式下对eMMC上的文件系统进行更新了。

- **第一步，将虚拟机上的文件系统打包做成tar.gz文件。注意要直接进入文件系统根目录下打包：**

```bash
$ cd /mnt/sanway-emmc-rootfs-4.9-stm32mp153a-swa1530/
$ sudo tar czvf rootfs_new.tar.gz ./
```

这样就生成了一个新的压缩包：rootfs_new.tar.gz。并且这个压缩包可以在你的装置上立即实时的可以看到：

```bash
root@SWA1530:~# ll /
drwxr-xr-x    3 1000     tisdk         1024 Dec 25  2015 Settings
drwxr-xr-x    2 1000     tisdk         2048 Jun 17  2021 bin
drwxr-xr-x    7 root     root          1024 Jul  2  2019 boot
drwxr-xr-x   10 root     root          3960 Jun 13 15:00 dev
drwxr-xr-x   31 1000     tisdk         2048 May 26  2021 etc
drwxr-xr-x    4 1000     tisdk         1024 Jul  2  2019 home
lrwxrwxrwx    1 root     root            10 Aug 15  2019 init -> /sbin/init
drwxr-xr-x    8 1000     tisdk         4096 Jun 12 09:13 lib
drwx------    2 1000     tisdk         1024 Dec 25  2015 lost+found
lrwxrwxrwx    1 root     root            10 May 26  2021 media -> /run/media
drwxr-xr-x    3 1000     tisdk         1024 Sep 13  2016 mnt
drwxr-xr-x    2 root     root          1024 May 26  2021 opt
dr-xr-xr-x  165 root     root             0 Jun 13 14:59 proc
lrwxrwxrwx    1 root     root            15 Jun 17  2021 root -> /usr/local/root
-rw-r--r--    1 root     root     170247514 Jun 13 07:12 rootfs_new.tar.gz
drwxr-xr-x    6 root     root           260 Jun 13 15:00 run
drwxr-xr-x    2 1000     tisdk         2048 Jun 13 01:54 sbin
drwxr-xr-x    3 1000     tisdk         1024 Dec 25  2015 srv
dr-xr-xr-x   12 root     root             0 Jun 13 14:59 sys
lrwxrwxrwx    1 1000     tisdk            8 Dec 25  2015 tmp -> /var/tmp
drwxr-xr-x   11 1000     tisdk         1024 Dec 25  2015 usr
drwxr-xr-x    8 1000     tisdk         1024 Jun 28  2019 var
drwxr-xr-x    2 1000     tisdk         1024 Mar 29  2018 work
```

- **第二步，将含有根文件系统的emmc分区挂载。**

`CCE-3088`的eMMC上的根文件系统分区为：`/dev/mmcblk1p4`。如果不确定，可以用`sgdisk`命令来看一下：

```bash
root@SWA1530:~# sgdisk -p /dev/mmcblk1
Disk /dev/mmcblk1: 7733248 sectors, 3.7 GiB
Logical sector size: 512 bytes
Disk identifier (GUID): 2C4D5B99-12CE-4494-A274-BF915A7B7647
Partition table holds up to 128 entries
First usable sector is 34, last usable sector is 7733214
Partitions will be aligned on 1-sector boundaries
Total free space is 155614 sectors (76.0 MiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1              34            4129   2.0 MiB     8301  fip
   2            4130          135201   64.0 MiB    8300  bootfs
   3          135202          167969   16.0 MiB    8300  vendorfs
   4          167970         1703970   750.0 MiB   8300  rootfs
   5         1703971         7577600   2.8 GiB     8300  userfs
```

上面标识为4，Name为：rootfs的分区，即为eMMC的根文件系统分区。挂载该分区：

```bash
root@SWA1530:~# mount /dev/mmcblk1p4 /mnt
root@SWA1530:~# ll /mnt
drwxr-xr-x    3 1000     tisdk         1024 Jun 12 19:21 Settings
drwxr-xr-x    2 1000     tisdk         2048 Jun 12 19:20 bin
drwxr-xr-x    2 1000     tisdk         1024 Jan  9  2016 boot
drwxr-xr-x    2 1000     tisdk         1024 Jun 12 19:20 dev
drwxr-xr-x   31 1000     tisdk         2048 Jun 13 02:01 etc
drwxr-xr-x    4 1000     tisdk         1024 Jun 12 19:20 home
lrwxrwxrwx    1 root     root            10 Jun 12 19:21 init -> /sbin/init
drwxr-xr-x    8 1000     tisdk         4096 Jun 12 19:21 lib
drwx------    2 1000     tisdk         1024 Dec 25  2015 lost+found
lrwxrwxrwx    1 root     root            10 Jun 12 19:21 media -> /run/media
drwxr-xr-x    3 1000     tisdk         1024 Jun 12 19:21 mnt
drwxr-xr-x    2 root     root          1024 May 26  2021 opt
drwxr-xr-x    2 1000     tisdk         1024 Dec 25  2015 proc
lrwxrwxrwx    1 root     root            15 Jun 12 19:21 root -> /usr/local/root
drwxr-xr-x    6 root     root          1024 Jun 12 19:21 run
drwxr-xr-x    2 1000     tisdk         2048 Jun 13 02:13 sbin
drwxr-xr-x    3 1000     tisdk         1024 Jun 12 19:21 srv
drwxr-xr-x    2 1000     tisdk         1024 Dec 25  2015 sys
lrwxrwxrwx    1 root     root             8 Jun 12 19:21 tmp -> /var/tmp
drwxr-xr-x   11 1000     tisdk         1024 Jun 12 19:21 usr
drwxr-xr-x    9 1000     tisdk         1024 Jun 12 19:28 var
drwxr-xr-x    2 1000     tisdk         1024 Jun 12 19:21 work
```

- **第三步，删除该分区上的所有内容，然后再将刚刚我们压缩好的新的文件系统解压缩到这个分区上。**

```bash
root@SWA1530:~# rm -rf /mnt/*
root@SWA1530:~# tar xzvf /rootfs_new.tar.gz -C /mnt/
root@SWA1530:~# sync
```

注意解压缩完了之后要`sync`同步一下。

操作完成后，就可以直接重启装置了。装置重启后将会自动按照新的文件系统来加载工作。如果对这个文件系统不满意，或者还需要增加新的内容，也可以重新执行上述的操作。

