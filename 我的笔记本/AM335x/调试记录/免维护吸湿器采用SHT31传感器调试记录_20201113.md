# 免维护吸湿器采用SHT31传感器调试记录_20201113

### 1、温湿度传感器采用SHT31，硬件上接口采用CPU的第2路I2C总线，4.19的内核中有相应驱动：
	
	kernel_4.19/drivers/hwmon/sht3x.c

### 2、内核中将其编译为模块方式，启动时需要插入模块加载驱动。因为该驱动使用crc8校验，因此在加载之前，需要先加载crc8的模块驱动：
	
	insmod crc8.ko
	insmod sht3x.ko

### 3、此时驱动还不能使用，因为该驱动不能使用设备文件树来描述加载，而需要采用以下方式：
	
	echo sht3x 0x44 > /sys/bus/i2c/devices/i2c-2/new_device
	其中sht3x是驱动源代码中的驱动名称，0x44是sht31的默认I2C地址。
	
	如果设备加载无误，则在调试终端中会提示：		
	[  196.100878] i2c i2c-2: new_device: Instantiated device sht3x at 0x44
	表示驱动加载成功，且找到了真实的硬件设备。
	
### 4、设备使用：
	
	读取设备采样的值在系统目录：
	/sys/bus/i2c/devices/i2c-2/2-0044/hwmon/hwmon0/
	该目录下有如下参数：
	
	sysfs-Interface
	---------------
	
	temp1_input:        temperature input
	humidity1_input:    humidity input
	temp1_max:          temperature max value
	temp1_max_hyst:     temperature hysteresis value for max limit
	humidity1_max:      humidity max value
	humidity1_max_hyst: humidity hysteresis value for max limit
	temp1_min:          temperature min value
	temp1_min_hyst:     temperature hysteresis value for min limit
	humidity1_min:      humidity min value
	humidity1_min_hyst: humidity hysteresis value for min limit
	temp1_alarm:        alarm flag is set to 1 if the temperature is outside the
	                    configured limits. Alarm only works in periodic measure mode
	humidity1_alarm:    alarm flag is set to 1 if the humidity is outside the
	                    configured limits. Alarm only works in periodic measure mode
	heater_enable:      heater enable, heating element removes excess humidity from
	                    sensor
	                        0: turned off
	                        1: turned on
	update_interval:    update interval, 0 for single shot, interval in msec
	                    for periodic measurement. If the interval is not supported
	                    by the sensor, the next faster interval is chosen
	                    
	temp1_input中存储的是温度值，humidity1_input存储的是湿度值，注意存储值均放大了1000倍。例如：
	cat /sys/bus/i2c/devices/i2c-2/2-0044/hwmon/hwmon0/temp1_input
	返回值：29976，表示温度值为：29.976摄氏度

        update_interval说明：
        The sht3x sensor supports a single shot mode as well as 5 periodic measure
        modes, which can be controlled with the update_interval sysfs interface.
        The allowed update_interval in milliseconds are as follows:
          *     0   single shot mode
          *  2000   0.5 Hz periodic measurement
          *  1000   1   Hz periodic measurement
          *   500   2   Hz periodic measurement
          *   250   4   Hz periodic measurement
          *   100  10   Hz periodic measurement

        In the periodic measure mode, the sensor automatically triggers a measurement
        with the configured update interval on the chip. When a temperature or humidity
        reading exceeds the configured limits, the alert attribute is set to 1 and
        the alert pin on the sensor is set to high.
        When the temperature and humidity readings move back between the hysteresis
        values, the alert bit is set to 0 and the alert pin on the sensor is set to low.
